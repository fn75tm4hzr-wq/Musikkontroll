<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Musikkontroll</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{
      --bg:#f8fafc;--ink:#0f172a;--muted:#334155;--card:#fff;--br:#e2e8f0;--ok:#10b981;--warn:#f59e0b;--dark:#0f172a;--hint:#f1f5f9;
      --list-zoom: 1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font:16px -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin:0; background:var(--bg); color:var(--ink); padding-bottom:calc(120px + env(safe-area-inset-bottom));}
    header{position:sticky;top:0;z-index:20;background:var(--dark);color:#fff;padding:12px env(safe-area-inset-left) 12px; text-align:center;font-size:20px;font-weight:700}
    nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid var(--br);display:flex;z-index:30;padding-bottom:env(safe-area-inset-bottom)}
    nav button{flex:1;padding:14px 10px;background:none;font-weight:600;color:var(--ink);border:none;font-size:16px}
    nav button.active{background:var(--dark);color:#fff}

    .page{display:none;max-width:760px;margin:auto;padding:10px}
    .page.active{display:block}
    .card{background:var(--card);padding:10px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08);margin:8px 0}
    label{font-weight:600;color:var(--muted);margin:4px 0 6px;display:block;font-size:14px}
    input,select,textarea{width:100%;padding:10px;border:2px solid var(--br);border-radius:10px;font-size:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
    .row>*{flex:1;min-width:120px}
    .row .icon-btn{width:36px;height:36px;font-size:18px;background:var(--hint);color:var(--ink);border:none;border-radius:8px;flex:0 0 auto;cursor:pointer}
    button{display:flex;align-items:center;justify-content:center;background:var(--dark);color:#fff;border:none;padding:12px;border-radius:10px;font-size:16px;font-weight:600;margin:4px 0;width:100%;cursor:pointer}
    .btn-green{background:var(--ok)}
    .btn-amber{background:var(--warn)}
    .btn-gray{background:#6b7280}
    .help{font-size:13px;color:#475569}
    .log{font-size:13px;color:var(--ok);background:#f0fdf4;padding:8px;border-radius:8px;margin-top:6px}
    .hidden{display:none}

    /* Lister â€“ mer kompakt */
    #lister .card.compact{padding:8px}
    #lister .compact input{padding:8px}
    .list-wrap{transform-origin: top left; scale: var(--list-zoom)}
    .list-table{width:100%;border-collapse:collapse}
    .list-table th{position:sticky;top:0;background:var(--hint);padding:6px 8px;text-align:left;font-weight:700;font-size:14px}
    .list-table td{padding:6px 8px;vertical-align:top;border-bottom:1px solid var(--br)}
    .list-row{background:#fff}
    .list-row:hover{background:#f9fafb}
    .list-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .zoom-btns{display:flex;gap:6px}
    .zoom-btns button{width:auto;padding:6px 10px;font-size:14px}

    /* Toast */
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(70px + env(safe-area-inset-bottom));background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,.25);opacity:0;transition:opacity .25s}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <header aria-live="polite">ðŸŽµ Musikkontroll v1.8.5</header>

  <!-- LOGIN -->
  <main id="login" class="page active" style="max-width:420px">
    <h1>Logg inn</h1>
    <div class="card">
      <label for="email">E-post</label>
      <input id="email" type="email" autocomplete="username" />
      <label for="password">Passord</label>
      <input id="password" type="password" autocomplete="current-password" />
      <div class="row">
        <button id="loginBtn">Logg inn</button>
        <button class="btn-green" id="signupBtn">Opprett bruker</button>
      </div>
      <div class="row"><button class="btn-gray" id="magicBtn">Send magisk lenke</button></div>
      <div id="auth-error" class="log" style="background:#fef2f2;color:#991b1b;display:none"></div>
    </div>
  </main>

  <!-- SKJEMA -->
  <div id="kontroll" class="page">
    <div class="card">
      <label for="orgnr">Org.nr</label>
      <div class="row">
        <input id="orgnr" inputmode="numeric" maxlength="9" placeholder="9 siffer" />
        <button class="icon-btn" id="brregBtn" title="SÃ¸k i Enhetsregisteret">ðŸ”Ž</button>
      </div>
      <div class="row">
        <button class="btn-gray" id="resetBtn">ðŸ—‘ Nullstill</button>
        <button class="btn-gray" id="logoutBtn">Logg ut</button>
      </div>
      <div id="brreg-log" class="log" aria-live="polite"></div>
    </div>

    <div class="card"><label for="navn">BesÃ¸ksnavn</label><input id="navn" /></div>
    <div class="card"><label for="besoksadresse">Adresse (besÃ¸k)</label><input id="besoksadresse" /></div>
    <div class="card">
      <label>Post (besÃ¸k)</label>
      <div class="row"><input id="besoks_postnr" inputmode="numeric" maxlength="4" placeholder="Postnr"><input id="besoks_poststed" placeholder="Poststed"></div>
    </div>
    <div class="card"><label for="firma">Firmanavn</label><input id="firma" /></div>
    <div class="card">
      <label>Firmaadresse (post)</label>
      <div class="row">
        <input id="firma_postadresse" placeholder="Gateadresse">
        <input id="firma_postnr" inputmode="numeric" maxlength="4" placeholder="Postnr">
        <input id="firma_poststed" placeholder="Poststed">
      </div>
    </div>

    <div class="card">
      <strong>StÃ¸rrelse</strong>
      <div id="tariff-rows"></div>
      <button class="btn-green" id="addRowBtn">+ Ny linje</button>

      <label for="hoyttalere">HÃ¸yttalere</label><input id="hoyttalere">
      <label for="kommentar">Kommentar</label><textarea id="kommentar" rows="2"></textarea>
      <div class="row">
        <button id="saveDraftBtn">Lagre</button>
        <button class="btn-amber" id="printBtn">Print</button>
        <button class="btn-green" id="sendBtn">Send PDF</button>
      </div>
    </div>
  </div>

  <!-- LISTER -->
  <div id="lister" class="page">
    <div class="card compact">
      <div class="list-header">
        <div style="flex:1;min-width:160px">
          <input type="file" id="excelFile" accept=".xlsx" />
          <div class="help">Importer Excel (Kommentar, Orgnummer, Navn, Gateadresse, Postnr, Poststed)</div>
        </div>
        <div class="zoom-btns">
          <button class="btn-gray" id="zoomOut">Aâˆ’</button>
          <button class="btn-gray" id="zoomReset">100%</button>
          <button class="btn-gray" id="zoomIn">A+</button>
        </div>
      </div>
      <div class="row compact">
        <input id="search" placeholder="Filtrer i aktive lister" />
      </div>
    </div>

    <div class="list-wrap">
      <div id="lists-dashboard"></div>
    </div>
  </div>

  <!-- KONTROLLERT -->
  <div id="kontrollert" class="page">
    <div class="row" style="gap:8px">
      <button class="btn-amber" id="exportMonthBtn">Eksporter (denne mÃ¥neden)</button>
      <button class="btn-gray" id="refreshArchiveBtn">Oppdater</button>
    </div>
    <div id="archive"></div>
  </div>

  <nav aria-label="Hovednavigasjon">
    <button data-page="kontroll" class="active">Skjema</button>
    <button data-page="lister">Lister</button>
    <button data-page="kontrollert">Kontrollert</button>
  </nav>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
  (function(){
    const { createClient } = window.supabase;
    const SUPABASE_URL = 'https://lztitjaumvqgycpcvvwl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6dGl0amF1bXZxZ3ljcGN2dndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjQ2NTEsImV4cCI6MjA3Nzg0MDY1MX0.ZDK2ymr5vYG3HP5-j-CRv3UAe5G-VKGIUOObbhd6cyU';
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $$ = (s)=>document.querySelector(s);
    const $$$ = (s)=>Array.from(document.querySelectorAll(s));
    const toast = (m)=>{ const t=$$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400); };
    const sanitize = (str='')=>String(str).replace(/[<>]/g,c=>({'<':'&lt;','>':'&gt;'}[c]));
    const debounce=(fn,ms=350)=>{ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a),ms);} };

    function show(page){ $$$('.page').forEach(x=>x.classList.remove('active')); $$('#'+page).classList.add('active'); $$$('nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===page)); }

    async function currentUser(){ const { data:{ user } } = await supa.auth.getUser(); return user; }
    async function signOut(){ await supa.auth.signOut(); toast('Logget ut'); show('login'); }

    // ====== Brreg ======
    const brregLog = $$('#brreg-log');
    async function searchBrreg(){
      const n=$$('#orgnr').value.replace(/\D/g,'');
      if(n.length!==9){ brregLog.textContent='Org.nr mÃ¥ ha 9 siffer'; return; }
      brregLog.textContent='SÃ¸kerâ€¦';
      try{
        const r=await fetch('https://data.brreg.no/enhetsregisteret/api/enheter/'+n);
        if(!r.ok) throw new Error();
        const d=await r.json();
        const a=d.forretningsadresse||d.beliggenhetsadresse||{};
        $$('#firma').value=d.navn||'';
        $$('#firma_postadresse').value=(a.adresse||a.adressebeskrivelse||a.gate||'')||'';
        $$('#firma_postnr').value=a.postnummer||'';
        $$('#firma_poststed').value=a.poststed||'';
        brregLog.textContent='Firmaadresse hentet';
      }catch(e){ brregLog.textContent='Ikke funnet'; }
    }
    const searchBrregDebounced = debounce(searchBrreg, 350);

    // ====== Tariff-rader (per linje: type + arena + dager pr Ã¥r) ======
    function defaultDays(kind){ // kind: 'Serveringssted' | 'Kundelokale' | 'Fremtredende'
      if(kind==='Fremtredende') return 104;
      if(kind==='Kundelokale') return 310;
      return 356; // Serveringssted
    }
    function rowTemplate(preset){
      const musType = preset?.musType || 'Bakgrunn';           // Bakgrunn | Fremtredende
      const arena   = preset?.arena   || 'Serveringssted';     // Serveringssted | Kundelokale
      const kvm     = preset?.kvm     || '';
      const seter   = preset?.seter   || '';
      const dager   = preset?.dager   ?? defaultDays(musType==='Fremtredende' ? 'Fremtredende' : arena);

      return `<div class="row tariff-row">
        <select class="sel-mus">
          <option ${musType==='Bakgrunn'?'selected':''}>Bakgrunn</option>
          <option ${musType==='Fremtredende'?'selected':''}>Fremtredende</option>
        </select>
        <select class="sel-arena">
          <option ${arena==='Serveringssted'?'selected':''}>Serveringssted</option>
          <option ${arena==='Kundelokale'?'selected':''}>Kundelokale</option>
        </select>
        <input class="in-kvm" type="number" placeholder="StÃ¸rrelse (kvm)" value="${sanitize(kvm)}">
        <input class="in-seter" type="number" placeholder="Sitteplasser" value="${sanitize(seter)}">
        <input class="in-dager" type="number" placeholder="Dager pr. Ã¥r" value="${sanitize(dager)}">
        <button class="icon-btn" title="Fjern" onclick="this.closest('.tariff-row').remove()">âˆ’</button>
      </div>`;
    }
    function addRow(preset){ $$('#tariff-rows').insertAdjacentHTML('beforeend', rowTemplate(preset)); }
    function updateTariffDefault(){ $$('#tariff-rows').innerHTML=''; addRow({}); }

    function getFormData(){
      const rows=[];
      $$('#tariff-rows').querySelectorAll('.tariff-row').forEach(r=>{
        const musType=r.querySelector('.sel-mus').value;           // Bakgrunn/Fremtredende
        const arena  =r.querySelector('.sel-arena').value;         // Serveringssted/Kundelokale
        const kvm    =r.querySelector('.in-kvm').value;
        const seter  =r.querySelector('.in-seter').value;
        const dager  =r.querySelector('.in-dager').value || defaultDays(musType==='Fremtredende'?'Fremtredende':arena);
        rows.push({ type:musType, arena, kvm, seter, dager });
      });
      return {
        orgnr: $$('#orgnr').value,
        navn: $$('#navn').value,
        adresse: $$('#besoksadresse').value,
        postnr: $$('#besoks_postnr').value,
        poststed: $$('#besoks_poststed').value,
        firma: $$('#firma').value,
        firma_postadresse: $$('#firma_postadresse').value,
        firma_postnr: $$('#firma_postnr').value,
        firma_poststed: $$('#firma_poststed').value,
        tariff: rows,
        hoyttalere: $$('#hoyttalere').value,
        kommentar: $$('#kommentar').value,
        dato: new Date().toISOString()
      };
    }
    function resetForm(){
      ['orgnr','navn','besoksadresse','besoks_postnr','besoks_poststed','firma','firma_postadresse','firma_postnr','firma_poststed','hoyttalere','kommentar'].forEach(id=> $$('#'+id).value='');
      $$('#tariff-rows').innerHTML=''; addRow({}); brregLog.textContent='';
      toast('Skjema nullstilt');
    }

    // ====== Supabase data ======
    async function saveControl(status){
      const user = await currentUser(); if(!user){ toast('Innlogging kreves'); return; }
      const payload=getFormData();
      const { error } = await supa.from('controls').insert({ user_id:user.id, orgnr: payload.orgnr||null, data: payload, status });
      if(error){ console.error(error); toast('Kunne ikke lagre'); return; }
      toast(status==='sent'?'Sendt':'Lagret');
      if(status==='sent'){ await generatePDF(payload); await renderArchive(); }
    }
    async function fetchControls(){ const { data } = await supa.from('controls').select('*').order('created_at',{ascending:false}); return data||[]; }
    async function fetchLists(){ const { data } = await supa.from('lists').select('*').order('created_at',{ascending:false}); return data||[]; }
    async function saveList(name, items){
      const user=await currentUser(); if(!user){ toast('Innlogging kreves'); return; }
      const { error } = await supa.from('lists').insert({ user_id:user.id, name, items });
      if(error){ console.error(error); toast('Kunne ikke lagre liste'); return; }
      await renderDashboard(); toast('Liste importert');
    }

    // ====== PDF med logoer ======
    async function imgToDataURL(src){
      return new Promise((resolve,reject)=>{
        const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{
          const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
          const ctx=c.getContext('2d'); ctx.drawImage(img,0,0); resolve(c.toDataURL('image/png'));
        }; img.onerror=reject; img.src=src;
      });
    }
    async function generatePDF(data){
      const { jsPDF } = window.jspdf||{}; if(!jsPDF){ alert('PDF-bibliotek mangler'); return; }
      const doc=new jsPDF({ unit:'mm', format:'a4' });

      // Logoer
      try{
        const tono=await imgToDataURL('tono_logo.png');
        const gramo=await imgToDataURL('gramo_logo.png');
        doc.addImage(tono,'PNG',15,12,28,10);
        doc.addImage(gramo,'PNG',doc.internal.pageSize.getWidth()-43,12,28,10);
      }catch{}

      let y=28;
      doc.setFontSize(14); doc.text('Kontrollskjema for bruk av musikk', 15, y); y+=8;
      doc.setFontSize(11);

      const lines=[
        `BesÃ¸ksnavn: ${data.navn||''}`,
        `BesÃ¸ksadresse: ${data.adresse||''}`,
        `Post: ${data.postnr||''} ${data.poststed||''}`,
      ];
      lines.forEach(t=>{ doc.text(t,15,y); y+=6; });

      // Dato/tid + kontrollÃ¸r
      const dt=new Date();
      const userEmail = (supa.auth.getSession()).data?.session?.user?.email || '';
      const metaName  = (supa.auth.getSession()).data?.session?.user?.user_metadata?.name || '';
      const firstName = (metaName||userEmail).split('@')[0].split(/[.\s]/)[0] || '';
      doc.text(`Kontrollert: ${dt.toLocaleDateString('nb-NO')} kl ${dt.toLocaleTimeString('nb-NO',{hour:'2-digit',minute:'2-digit'})}`, 15, y); y+=6;
      doc.text(`KontrollÃ¸r: ${firstName}`, 15, y); y+=8;

      doc.text('Tarifflinjer:', 15, y); y+=6;
      (data.tariff||[]).forEach((t,i)=>{
        const mus = t.type==='Fremtredende' ? 'Fremtredende musikk' : 'Bakgrunnsmusikk';
        const arena = t.arena || 'Serveringssted';
        const line = `${i+1}. ${mus} â€¢ ${arena} â€¢ ${t.kvm||'-'} kvm${t.seter?(' â€¢ '+t.seter+' seter'):''} â€¢ ${t.dager||'-'} dager/Ã¥r`;
        doc.text(line, 20, y); y+=6;
      });
      y+=2;

      doc.text(`HÃ¸yttalere: ${data.hoyttalere||''}`,15,y); y+=6;
      doc.text('Kommentar:',15,y); y+=6;
      const block = doc.splitTextToSize(data.kommentar||'', 180); doc.text(block, 20, y); y += block.length*6 + 6;

      // Footer
      y+=6;
      doc.text('TONO â€¢ GRAMO', 15, y); y+=6;
      doc.text('TONO â€“ Kongens gate 12, 0153 Oslo â€“ www.tono.no', 15, y);

      doc.save(`kontroll-${data.orgnr||''}.pdf`);
    }
    function printReceipt(){ generatePDF(getFormData()); }

    // ====== Import Excel + Lister (med zoom) ======
    async function importExcel(e){
      const file=e.target.files[0]; if(!file) return;
      try{
        const reader=new FileReader();
        reader.onload = async ev => {
          const data = new Uint8Array(ev.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.SheetNames[0];
          const ws = wb.Sheets[sheet];
          const json = XLSX.utils.sheet_to_json(ws,{ header:1, raw:false, defval:'' });
          const head = (json[0]||[]).map(s=>String(s||'').trim().toLowerCase());
          const wanted = { org:['orgnummer','org nr','organisasjonsnr','organisasjonsnummer','orgnr'], navn:['navn','besÃ¸ksnavn','bedriftsnavn','foretaksnavn'], gate:['gateadresse','adresse','besÃ¸ksadresse','adressse','gatenavn'], postnr:['postnr','postnummer','post nr'], poststed:['poststed','sted'], kommentar:['kommentar','notat','note','merknad'] };
          const idx = {}; Object.keys(wanted).forEach(k=> idx[k]=head.findIndex(h=> wanted[k].some(w=> h===w)));
          const items=[];
          for(let r=1;r<json.length;r++){
            const row=json[r]||[], get=(k)=>{const i=idx[k]; return i==null||i<0 ? '' : String(row[i]||'').trim()};
            const org = get('org').replace(/\s+/g,'').replace(/[^0-9]/g,'');
            const itm = { Orgnummer: org, Navn:get('navn'), Gateadresse:get('gate'), Postnr:get('postnr'), Poststed:get('poststed'), Kommentar:get('kommentar'), color:0 };
            if(itm.Navn || itm.Gateadresse) items.push(itm);
          }
          const name = (file.name||'Liste').replace(/\.(xlsx|xls)$/i,'');
          await saveList(name, items);
        };
        reader.readAsArrayBuffer(file);
      }catch(err){ console.error(err); toast('Kunne ikke lese Excel'); }
    }

    async function renderDashboard(){
      const lists=await fetchLists();
      const d=$$('#lists-dashboard'); d.innerHTML='';
      const q = ($$('#search').value||'').toLowerCase();
      lists.forEach(L=>{
        const box=document.createElement('div'); box.className='card';
        box.innerHTML = `
          <div class="list-header">
            <b>${sanitize(L.name)}</b>
            <small>${new Date(L.created_at).toLocaleDateString('nb-NO')}</small>
          </div>
          <div class="help" style="margin-bottom:6px">${L.items.length} steder</div>
          <div style="max-height:420px;overflow:auto;border:1px solid var(--br);border-radius:10px">
            <table class="list-table">
              <thead><tr><th>Orgnummer</th><th>BesÃ¸ksnavn</th><th>Gateadresse</th><th>Post</th><th>Kommentar</th><th></th></tr></thead>
              <tbody id="tbody-${L.id}"></tbody>
            </table>
          </div>`;
        d.appendChild(box);
        const tbody=$$('#tbody-'+L.id);
        L.items.forEach((it,i)=>{
          const hay=[it.Orgnummer,it.Navn,it.Gateadresse,it.Postnr,it.Poststed,it.Kommentar].join(' ').toLowerCase();
          if(q && !hay.includes(q)) return;
          const tr=document.createElement('tr'); tr.className='list-row';
          tr.innerHTML = `
            <td>${sanitize(it.Orgnummer||'')}</td>
            <td>
              <button style="all:unset;cursor:pointer;color:#111;font-weight:700"
                onclick="(function(){
                  document.getElementById('orgnr').value=${JSON.stringify(it.Orgnummer||'')};
                  document.getElementById('navn').value=${JSON.stringify(it.Navn||'')};
                  document.getElementById('besoksadresse').value=${JSON.stringify(it.Gateadresse||'')};
                  document.getElementById('besoks_postnr').value=${JSON.stringify(it.Postnr||'')};
                  document.getElementById('besoks_poststed').value=${JSON.stringify(it.Poststed||'')};
                  show('kontroll');
                })()"
              >${sanitize(it.Navn||'')}</button>
            </td>
            <td>${sanitize(it.Gateadresse||'')}</td>
            <td>${sanitize((it.Postnr||'')+' '+(it.Poststed||''))}</td>
            <td contenteditable onblur="(async()=>{ try{ const { data:list } = await supa.from('lists').select('*').eq('id','${L.id}').single(); list.items[${i}].Kommentar=this.innerText; await supa.from('lists').update({ items:list.items }).eq('id','${L.id}'); }catch(e){ console.error(e) } })()">${sanitize(it.Kommentar||'Trykk for notat')}</td>
            <td><button class="btn-gray" style="width:auto;padding:6px 10px" onclick="(async()=>{ if(!confirm('Slette raden?')) return; try{ const { data:list } = await supa.from('lists').select('*').eq('id','${L.id}').single(); list.items.splice(${i},1); await supa.from('lists').update({ items:list.items }).eq('id','${L.id}'); location.reload(); }catch(e){ console.error(e)} })()">Slett</button></td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    // ====== Kontrollert (eksport + slett) ======
    function calcPoints(row){
      // poeng per linje (TONO/GRAMO like)
      // serveringssted 350, kundelokale 200, fremtredende 550
      let tono=0, gramo=0;
      for(const t of (row.data?.tariff||[])){
        const isFrem = (t.type==='Fremtredende');
        if(isFrem){ tono += 550; gramo += 550; }
        else if(t.arena==='Kundelokale'){ tono += 200; gramo += 200; }
        else { tono += 350; gramo += 350; }
      }
      return { tono, gramo };
    }

    async function renderArchive(){
      const rows = await fetchControls();
      const div = $$('#archive'); div.innerHTML='';
      const byMonth = {};
      rows.forEach(c=>{ const m=new Date(c.created_at).toLocaleDateString('nb-NO',{year:'numeric',month:'long'}); (byMonth[m]=byMonth[m]||[]).push(c); });

      Object.keys(byMonth).sort().reverse().forEach(month=>{
        const header=document.createElement('div'); header.className='card'; header.innerHTML='<b>'+sanitize(month)+'</b>'; div.appendChild(header);
        byMonth[month].forEach(c=>{
          const data=c.data||{}; const li=document.createElement('div'); li.className='card';
          const pts = calcPoints(c);
          li.innerHTML = `
            <div class="row" style="align-items:center">
              <div style="flex:1">
                <b>${sanitize(data.navn||'')}</b> â€“ ${new Date(c.created_at).toLocaleDateString('nb-NO')}<br>
                ${(data.tariff||[]).map(t=>sanitize(`${t.kvm||''} kvm ${t.seter?('â€¢ '+t.seter+' seter â€¢ '):'â€¢ '}${t.dager||''} dager â€¢ ${t.type} â€¢ ${t.arena||''}`)).join('<br>')}
                <div class="help">Poeng: TONO ${pts.tono} â€¢ GRAMO ${pts.gramo}</div>
              </div>
              <div style="width:120px;display:flex;gap:6px">
                <button class="btn-gray" style="width:auto" onclick="(async()=>{ if(!confirm('Slette kontroll?')) return; await supa.from('controls').delete().eq('id','${c.id}'); location.reload(); })()">Slett</button>
              </div>
            </div>`;
          div.appendChild(li);
        });
      });
    }

    async function exportMonth(){
      const rows=await fetchControls();
      const monthKey=new Date().toLocaleDateString('nb-NO',{year:'numeric',month:'long'});
      const filt=rows.filter(r=> new Date(r.created_at).toLocaleDateString('nb-NO',{year:'numeric',month:'long'})===monthKey);
      const out=[['Dato','Navn','Orgnr','Adresse','Post','Linje (musikk/arene/kvm/seter/dager)','TONO poeng','GRAMO poeng']];
      filt.forEach(r=>{
        const d=r.data||{};
        const pts=calcPoints(r);
        const linjer=(d.tariff||[]).map(t=> `${t.type}/${t.arena}/${t.kvm||''}/${t.seter||''}/${t.dager||''}`).join(' | ');
        out.push([ new Date(r.created_at).toLocaleDateString('nb-NO'), d.navn||'', d.orgnr||'', (d.adresse||''), `${d.postnr||''} ${d.poststed||''}`, linjer, pts.tono, pts.gramo ]);
      });
      const ws=XLSX.utils.aoa_to_sheet(out), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Eksport');
      XLSX.writeFile(wb, `kontrollert-${monthKey}.xlsx`);
    }

    // ====== Events ======
    $$$('nav button').forEach(b=> b.addEventListener('click', ()=> show(b.dataset.page)));
    $$('#brregBtn').addEventListener('click', ()=>searchBrreg());
    $$('#orgnr').addEventListener('input', ()=>{ const n=$$('#orgnr').value.replace(/\D/g,''); if(n.length===9) searchBrregDebounced(); });

    $$('#addRowBtn').addEventListener('click', ()=> addRow({}));
    $$('#resetBtn').addEventListener('click', resetForm);
    $$('#saveDraftBtn').addEventListener('click', ()=> saveControl('draft'));
    $$('#sendBtn').addEventListener('click', ()=> saveControl('sent'));
    $$('#printBtn').addEventListener('click', printReceipt);
    $$('#excelFile').addEventListener('change', importExcel);
    $$('#logoutBtn').addEventListener('click', signOut);

    $$('#search').addEventListener('input', debounce(renderDashboard, 200));
    $$('#exportMonthBtn').addEventListener('click', exportMonth);
    $$('#refreshArchiveBtn').addEventListener('click', renderArchive);

    // Zoom i lister
    function setZoom(v){ document.documentElement.style.setProperty('--list-zoom', String(v)); }
    let zoom=1;
    $$('#zoomIn').addEventListener('click', ()=>{ zoom=Math.min(zoom+0.1,1.6); setZoom(zoom); });
    $$('#zoomOut').addEventListener('click', ()=>{ zoom=Math.max(zoom-0.1,0.7); setZoom(zoom); });
    $$('#zoomReset').addEventListener('click', ()=>{ zoom=1; setZoom(zoom); });

    // Auth
    function showAuthError(err){ const el=$$('#auth-error'); el.style.display='block'; el.textContent=err?.message||'Ukjent feil'; }
    function clearAuthError(){ const el=$$('#auth-error'); el.style.display='none'; el.textContent=''; }
    async function loginEmailPass(email,password){ const {error}=await supa.auth.signInWithPassword({email,password}); if(error) throw error; }
    async function signupEmailPass(email,password){ const {error}=await supa.auth.signUp({email,password}); if(error) throw error; }
    async function magicLink(email){ const {error}=await supa.auth.signInWithOtp({email}); if(error) throw error; }

    $$('#loginBtn').addEventListener('click', async ()=>{
      clearAuthError();
      try{ await loginEmailPass($$('#email').value, $$('#password').value); toast('Innlogget'); }
      catch(e){ showAuthError(e); }
    });
    $$('#signupBtn').addEventListener('click', async ()=>{
      clearAuthError();
      try{ await signupEmailPass($$('#email').value, $$('#password').value); toast('Bruker opprettet'); }
      catch(e){ showAuthError(e); }
    });
    $$('#magicBtn').addEventListener('click', async ()=>{
      clearAuthError();
      try{ await magicLink($$('#email').value); toast('Sjekk e-post for magisk lenke'); }
      catch(e){ showAuthError(e); }
    });

    supa.auth.onAuthStateChange((_e, session)=>{ if(session?.user){ show('kontroll'); renderDashboard(); renderArchive(); updateTariffDefault(); } else { show('login'); }});
    (async function init(){
      const { data:{ session } } = await supa.auth.getSession();
      if(session?.user){ show('kontroll'); renderDashboard(); renderArchive(); updateTariffDefault(); } else { show('login'); updateTariffDefault(); }
    })();
  })();
  </script>
</body>
</html>
