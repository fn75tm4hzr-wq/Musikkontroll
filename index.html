<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Musikkontroll</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<style>
  :root{
    --bg:#f8fafc;--ink:#0f172a;--muted:#334155;--card:#fff;--br:#e2e8f0;
    --ok:#10b981;--warn:#f59e0b;--dark:#0f172a;--hint:#f1f5f9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{font:16px -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin:0; background:var(--bg); color:var(--ink);
       padding-bottom:var(--navpad, calc(140px + env(safe-area-inset-bottom))); }
  header{position:sticky;top:0;z-index:20;background:var(--dark);color:#fff;padding:12px env(safe-area-inset-left) 12px env(safe-area-inset-right);
         text-align:center;font-size:20px;font-weight:700}
  nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid var(--br);display:flex;z-index:30;
      padding-bottom:env(safe-area-inset-bottom)}
  nav button{flex:1;padding:16px;background:none;font-weight:600;color:var(--ink);border:none;font-size:16px;cursor:pointer}
  nav button.active{background:var(--dark);color:#fff}
  .page{display:none;padding:12px;max-width:760px;margin:auto}
  .page{padding-bottom:24px}
  .page.active{display:block}
  .page::after{content:"";display:block;height:calc(var(--navpad, calc(140px + env(safe-area-inset-bottom))) + 8px);}
  .card{background:var(--card);padding:10px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08);margin:8px 0}
  label{font-weight:600;color:var(--muted);margin:4px 0 6px;display:block;font-size:14px}
  input,select,textarea{width:100%;padding:10px;border:2px solid var(--br);border-radius:10px;font-size:16px}
  input[type="number"]{appearance:textfield}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .row>*{flex:1;min-width:120px}
  .row .icon-btn{width:36px;height:36px;font-size:18px;background:var(--hint);color:var(--ink);border:none;border-radius:8px;flex:0 0 auto}
  button{display:flex;align-items:center;justify-content:center;background:var(--dark);color:#fff;border:none;padding:12px;border-radius:10px;font-size:16px;font-weight:600;margin:4px 0;width:100%;cursor:pointer}
  .btn-green{background:var(--ok)} .btn-amber{background:var(--warn)} .btn-gray{background:#6b7280}
  .help{font-size:13px;color:#475569} .muted{color:#64748b}
  .log{font-size:13px;color:var(--ok);background:#f0fdf4;padding:8px;border-radius:8px;margin-top:6px}
  .hidden{display:none}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(70px + env(safe-area-inset-bottom));
         background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,.25);opacity:0;transition:opacity .25s}
  #toast.show{opacity:1}
  /* Lister tabell */
  .list-header{font-weight:600;display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px}
  .list-box{padding:10px;border-radius:10px;border:1px solid var(--br)}
  .list-viewport-wrap{max-height:360px;overflow:hidden;border:1px solid var(--br);border-radius:10px;background:#fff}
  .list-viewport{overflow:auto;padding:0; --fz:100%; font-size:var(--fz)}
  table{border-collapse:collapse;width:100%}
  th,td{padding:8px;border-bottom:1px solid var(--br);text-align:left;vertical-align:top}
  thead th{position:sticky;top:0;background:var(--hint);font-weight:700}
  .link-cell{all:unset;cursor:pointer;color:#0f172a;font-weight:700}
  .link-cell:focus{outline:2px solid #94a3b8;border-radius:4px}
  /* Mindre toppseksjoner i lister */
  .compact input[type="file"]{transform:scale(.9); transform-origin:left center}
  .compact .card:first-child{padding:8px}
  .compact .card:nth-child(2) input{padding:8px}
</style>
</head>
<body class="compact">
<header aria-live="polite">ðŸŽµ Musikkontroll v1.8.6</header>

<!-- LOGIN -->
<main id="login" class="page active" style="max-width:420px">
  <h1>Logg inn</h1>
  <div class="card">
    <label for="email">E-post</label>
    <input id="email" type="email" autocomplete="username" />
    <label for="password">Passord</label>
    <input id="password" type="password" autocomplete="current-password" />
    <div class="row">
      <button id="loginBtn">Logg inn</button>
      <button class="btn-green" id="signupBtn">Opprett bruker</button>
    </div>
    <div class="row"><button class="btn-gray" id="magicBtn">Send magisk lenke</button></div>
    <div id="auth-status" class="help muted"></div>
    <div id="auth-error" class="log" style="background:#fef2f2;color:#991b1b;display:none"></div>
  </div>
</main>

<!-- KONTROLLSKJEMA -->
<div id="kontroll" class="page">
  <h2 class="visually-hidden">Kontrollskjema</h2>

  <div class="card" aria-describedby="brreg-hjelp">
    <label for="orgnr">Org.nr</label>
    <div class="row">
      <input id="orgnr" inputmode="numeric" pattern="\d{9}" maxlength="9" placeholder="9 siffer" aria-describedby="brreg-hjelp" />
      <button class="icon-btn" id="brregBtn" title="SÃ¸k i Enhetsregisteret">ðŸ”Ž</button>
    </div>
    <div id="brreg-hjelp" class="help">SÃ¸k henter firmanavn og postadresse fra Brreg.</div>
    <div class="row">
      <button class="btn-gray" id="resetBtn">ðŸ—‘ Nullstill skjema</button>
      <button class="btn-gray" id="logoutBtn">Logg ut</button>
    </div>
    <div class="log" id="brreg-log"></div>
  </div>

  <div class="card"><label for="navn">BesÃ¸ksnavn</label><input id="navn" autocomplete="organization" /></div>
  <div class="card"><label for="besoksadresse">Adresse (besÃ¸k)</label><input id="besoksadresse" autocomplete="address-line1" /></div>
  <div class="card">
    <label>Post (besÃ¸k)</label>
    <div class="row"><input id="besoks_postnr" inputmode="numeric" maxlength="4" placeholder="Postnr"><input id="besoks_poststed" placeholder="Poststed"></div>
  </div>
  <div class="card"><label for="firma">Firmanavn</label><input id="firma" /></div>
  <div class="card">
    <label>Firmaadresse (post)</label>
    <div class="row">
      <input id="firma_postadresse" placeholder="Gateadresse">
      <input id="firma_postnr" inputmode="numeric" maxlength="4" placeholder="Postnr">
      <input id="firma_poststed" placeholder="Poststed">
    </div>
  </div>

  <div class="card">
    <strong>StÃ¸rrelse</strong>
    <div id="tariff-rows"></div>
    <button class="btn-green" id="addRowBtn">+ Ny linje</button>

    <label for="hoyttalere">HÃ¸yttalere</label><input id="hoyttalere">
    <label for="kommentar">Kommentar</label><textarea id="kommentar" rows="2"></textarea>

    <div class="row">
      <button id="saveDraftBtn">Lagre</button>
      <button class="btn-amber" id="printBtn">Print</button>
      <button class="btn-green" id="sendBtn">Send PDF</button>
    </div>
  </div>
</div>

<!-- LISTER -->
<div id="lister" class="page">
  <h2 class="visually-hidden">Lister</h2>
  <div class="card">
    <input type="file" id="excelFile" accept=".xlsx" />
    <div class="help">Kolonner: Kommentar, Orgnummer, Navn, Gateadresse, Postnr, Poststed</div>
  </div>
  <div class="card">
    <label for="search">SÃ¸k</label>
    <input id="search" placeholder="Filtrer i aktive lister" />
  </div>
  <div class="card">
    <div class="list-box">
      <div class="row" style="align-items:center">
        <div style="flex:0 0 auto;font-weight:600">Visning</div>
        <div class="row" style="flex:1;align-items:center;justify-content:flex-end">
          <button class="btn-gray" id="zoomOut" style="max-width:120px">âˆ’</button>
          <div id="zoomLabel" class="help" style="flex:0 0 auto;width:72px;text-align:center">100%</div>
          <button class="btn-gray" id="zoomIn" style="max-width:120px">+</button>
        </div>
      </div>
      <button id="zoomReset" class="btn-gray">Reset</button>
    </div>
  </div>
  <div id="lists-dashboard"></div>
</div>

<!-- KONTROLLERT -->
<div id="kontrollert" class="page">
  <h2 class="visually-hidden">Kontrollert</h2>
  <div class="row">
    <button class="btn-amber" id="exportBtn">Eksporter (poeng + dager)</button>
  </div>
  <div id="archive"></div>
</div>

<nav aria-label="Hovednavigasjon">
  <button data-page="kontroll" class="active">Skjema</button>
  <button data-page="lister">Lister</button>
  <button data-page="kontrollert">Kontrollert</button>
</nav>

<div id="toast" role="status" aria-live="polite"></div>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
(function(){
  if(!window.supabase || !window.supabase.createClient){ alert('Supabase-biblioteket mangler.'); return; }
  const { createClient } = window.supabase;

  // === Supabase config ===
  const SUPABASE_URL = 'https://lztitjaumvqgycpcvvwl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6dGl0amF1bXZxZ3ljcGN2dndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjQ2NTEsImV4cCI6MjA3Nzg0MDY1MX0.ZDK2ymr5vYG3HP5-j-CRv3UAe5G-VKGIUOObbhd6cyU';
  const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // === Utils ===
  const $$ = sel => document.querySelector(sel);
  const $$$ = sel => Array.from(document.querySelectorAll(sel));
  const toast = (msg)=>{ const t=$$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1500); };
  const setAuthStatus = (m)=>{ const el=$$('#auth-status'); if(el) el.textContent=m||''; };
  const sanitize = (s='') => String(s).replace(/[<>]/g, c => ({'<':'&lt;','>':'&gt;'}[c]));
  const debounce=(fn,ms=400)=>{ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a),ms); } };
  function goTop(){ try{ document.scrollingElement.scrollTo({top:0,behavior:'instant'}); }catch{} }
  function applyNavPad(){ const nav=document.querySelector('nav'); if(!nav) return;
    const h=nav.offsetHeight||0; document.documentElement.style.setProperty('--navpad', (h+48)+'px'); }
  function show(page){ $$$('.page').forEach(x=>x.classList.remove('active')); $$('#'+page).classList.add('active'); $$$('nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===page)); if(page==='kontroll') goTop(); }

  // === Auth ===
  function showAuthError(err){ const box=$$('#auth-error'); if(!box) return; box.style.display='block'; box.textContent=(err?.message||'Ukjent feil'); }
  function clearAuthError(){ const box=$$('#auth-error'); if(!box) return; box.style.display='none'; box.textContent=''; }
  async function currentUser(){ const { data:{ user } }=await supa.auth.getUser(); return user; }
  async function signOut(){ await supa.auth.signOut(); toast('Logget ut'); show('login'); }
  async function loginEmailPass(email,password){ const { error } = await supa.auth.signInWithPassword({ email,password }); if(error) throw error; }
  async function signupEmailPass(email,password){ const { error } = await supa.auth.signUp({ email,password }); if(error) throw error; }
  async function magicLink(email){ const { error } = await supa.auth.signInWithOtp({ email }); if(error) throw error; }

  // === Brreg ===
  const brregLog=$$('#brreg-log');
  async function searchBrreg(){
    const n=$$('#orgnr').value.replace(/\D/g,'');
    if(n.length!==9){ if(brregLog) brregLog.textContent='Org.nr mÃ¥ ha 9 siffer'; return; }
    if(brregLog) brregLog.textContent='SÃ¸kerâ€¦';
    try{
      const r=await fetch('https://data.brreg.no/enhetsregisteret/api/enheter/'+n);
      if(!r.ok) throw new Error('Ikke funnet');
      const d=await r.json();
      const a=d.forretningsadresse||d.beliggenhetsadresse||{};
      $$('#firma').value=d.navn||'';
      $$('#firma_postadresse').value=(a.adresse||a.adressebeskrivelse||a.gate||'')||'';
      $$('#firma_postnr').value=a.postnummer||'';
      $$('#firma_poststed').value=a.poststed||'';
      if(brregLog) brregLog.textContent='Firmaadresse hentet';
    }catch(e){ if(brregLog) brregLog.textContent='Ikke funnet'; }
  }
  const searchBrregDebounced = debounce(searchBrreg, 350);

  // === Tarifflinje per rad ===
  function rowTemplate(preset){
    const venue = preset?.venue || 'Serveringssted';  // Serveringssted/Kundelokale
    const music = preset?.music || 'Bakgrunnsmusikk'; // Bakgrunnsmusikk/Fremtredende
    const kvm   = preset?.kvm   || '';
    const seter = preset?.seter || '';
    const dager = preset?.dager ?? defaultDays({venue,music});

    return `<div class="row tariff-row" data-venue="${sanitize(venue)}">
      <select class="venueSel" onchange="(function(sel){
        const row=sel.closest('.tariff-row');
        const sp=row.querySelector('.seterWrap'); 
        const v=sel.value;
        // default dager ved bytte
        row.querySelector('.daysInp').value = (${defaultDays.toString()} )({venue:v,music:row.querySelector('.musicSel').value});
        if(v==='Kundelokale'){ sp.style.display='none'; row.querySelector('.seterInp').value=''; } else { sp.style.display=''; }
      })(this)">
        <option ${venue==='Serveringssted'?'selected':''}>Serveringssted</option>
        <option ${venue==='Kundelokale'?'selected':''}>Kundelokale</option>
      </select>

      <select class="musicSel" onchange="(function(sel){
        const row=sel.closest('.tariff-row');
        row.querySelector('.daysInp').value = (${defaultDays.toString()} )({venue:row.querySelector('.venueSel').value,music:sel.value});
      })(this)">
        <option ${music==='Bakgrunnsmusikk'?'selected':''}>Bakgrunnsmusikk</option>
        <option ${music==='Fremtredende'?'selected':''}>Fremtredende</option>
      </select>

      <input type="number" class="kvmInp" placeholder="kvm" value="${sanitize(kvm)}">

      <div class="seterWrap" style="${venue==='Kundelokale'?'display:none':''}">
        <input type="number" class="seterInp" placeholder="sitteplasser" value="${sanitize(seter)}">
      </div>

      <input type="number" class="daysInp" placeholder="dager pr Ã¥r" value="${sanitize(dager)}">
      <button type="button" class="icon-btn" title="Fjern" onclick="this.closest('.tariff-row').remove()">âˆ’</button>
    </div>`;
  }

  function defaultDays({venue,music}){
    if(music==='Fremtredende') return 104;
    if(venue==='Kundelokale') return 310;
    return 356; // Serveringssted + bakgrunn
  }

  function updateTariffDefault(){ $$('#tariff-rows').innerHTML=''; addRow(); }
  function addRow(preset){ $$('#tariff-rows').insertAdjacentHTML('beforeend', rowTemplate(preset)); }

  function resetForm(){
    if(!confirm('Nullstille hele skjemaet?')) return;
    ['orgnr','navn','besoksadresse','besoks_postnr','besoks_poststed','firma','firma_postadresse','firma_postnr','firma_poststed','hoyttalere','kommentar'].forEach(id=> $$('#'+id).value='');
    $$('#tariff-rows').innerHTML=''; if(brregLog) brregLog.textContent=''; addRow(); toast('Skjema nullstilt');
  }

  function getFormData(){
    const rows=[];
    $$('#tariff-rows').querySelectorAll('.tariff-row').forEach(r=>{
      rows.push({
        venue: r.querySelector('.venueSel').value,               // Serveringssted/Kundelokale
        music: r.querySelector('.musicSel').value,               // Bakgrunnsmusikk/Fremtredende
        kvm:   r.querySelector('.kvmInp').value,
        seter: r.querySelector('.seterInp')?.value||'',
        dager: r.querySelector('.daysInp').value
      });
    });
    return {
      orgnr: $$('#orgnr').value,
      navn: $$('#navn').value,
      adresse: $$('#besoksadresse').value,
      postnr: $$('#besoks_postnr').value,
      poststed: $$('#besoks_poststed').value,
      firma: $$('#firma').value,
      firma_postadresse: $$('#firma_postadresse').value,
      firma_postnr: $$('#firma_postnr').value,
      firma_poststed: $$('#firma_poststed').value,
      tariff: rows,
      hoyttalere: $$('#hoyttalere').value,
      kommentar: $$('#kommentar').value,
      dato: new Date().toISOString()
    };
  }

  // === Points & days helpers ===
  function pointsForLine(line){
    if(!line) return 0;
    if(line.music==='Fremtredende') return 550;
    return (line.venue==='Kundelokale') ? 200 : 350; // Serveringssted Bakgrunn
  }
  function pointsForControl(data){
    return (data?.tariff||[]).reduce((s,t)=> s + pointsForLine(t), 0);
  }
  function uniqueDaysForOrg(controls){
    const d=new Set(controls.map(c=> String(c.created_at).slice(0,10)));
    return d.size;
  }

  // === Supabase data ===
  async function saveControl(status){
    const user = await currentUser(); if(!user){ toast('Innlogging kreves'); return; }
    const payload=getFormData();
    const { error } = await supa.from('controls').insert({ user_id:user.id, orgnr: payload.orgnr||null, data: payload, status });
    if(error){ console.error(error); toast('Kunne ikke lagre'); return; }
    toast(status==='sent'?'Sendt':'Lagret');
    if(status==='sent'){ generatePDF(payload); await renderArchive(); }
  }
  async function fetchControls(){ const { data, error } = await supa.from('controls').select('*').order('created_at',{ ascending:false }); if(error){ console.error(error); return []; } return data; }
  async function saveList(name, items){ const user=await currentUser(); if(!user){ toast('Innlogging kreves'); return; } const { error } = await supa.from('lists').insert({ user_id:user.id, name, items }); if(error){ console.error(error); toast('Kunne ikke lagre liste'); return; } toast('Liste importert'); await renderDashboard(); }
  async function fetchLists(){ const { data, error } = await supa.from('lists').select('*').order('created_at',{ ascending:false }); if(error){ console.error(error); return []; } return data; }
  async function deleteControl(id){ if(!confirm('Slette denne kontrollen?')) return; const { error } = await supa.from('controls').delete().eq('id', id); if(error){ console.error(error); toast('Kunne ikke slette'); return; } toast('Slettet'); renderArchive(); }

  // === PDF (72mm) ===
  function firstNameFromEmail(email=''){
    const at=email.indexOf('@'); const raw = at>0 ? email.slice(0,at) : email;
    const parts = raw.split(/[.\-_ ]+/); const n = parts[0]||'KontrollÃ¸r';
    return n.charAt(0).toUpperCase()+n.slice(1);
  }

  function generatePDF(data){
    const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert('PDF-bibliotek mangler'); return; }
    const doc=new jsPDF({ unit:'mm', format:[72,200] }); let y=6;

    // Logos side-by-side (max hÃ¸yde 10mm)
    try{
      doc.addImage('tono_logo.png','PNG',4,y,28,0); // auto-height
      doc.addImage('gramo_logo.png','PNG',40,y,28,0);
      y+=12;
    }catch(_){ y+=2; }

    doc.setFontSize(10); doc.text('Kontrollskjema for bruk av musikk', 36, y, {align:'center'}); y+=6;

    doc.setFontSize(8);
    doc.text('BesÃ¸ksnavn: '+(data.navn||''), 4, y); y+=4;
    doc.text('BesÃ¸ksadresse: '+(data.adresse||''), 4, y); y+=4;
    doc.text('Post: '+(data.postnr||'')+' '+(data.poststed||''), 4, y); y+=4;

    const dt = new Date();
    doc.text('Kontrollert: '+dt.toLocaleDateString('nb-NO')+' kl '+dt.toLocaleTimeString('nb-NO',{hour:'2-digit',minute:'2-digit'}), 4, y); y+=4;

    doc.text('StÃ¸rrelse:', 4, y); y+=4;
    (data.tariff||[]).forEach((t,i)=>{
      const line = `${i+1}. ${t.venue} â€¢ ${t.music==='Fremtredende'?'Fremtredende musikk':'Bakgrunnsmusikk'} â€¢ ${t.kvm||'-'} kvm${t.seter?(' â€¢ '+t.seter+' seter'):''} â€¢ ${t.dager||'-'} dager`;
      doc.text(line, 6, y); y+=4;
    });

    y+=2; doc.text('HÃ¸yttalere: '+(data.hoyttalere||''), 4, y); y+=4;
    doc.text('Kommentar:', 4, y); y+=4;
    const block = doc.splitTextToSize(data.kommentar||'', 62); doc.text(block, 4, y); y+= (block.length*3)+3;

    const ctrlName = firstNameFromEmail(supa.auth.getUser().then(r=>r.data?.user?.email||'') || 'KontrollÃ¸r');
    doc.text('Signert: ______________________', 4, y); y+=5;
    doc.text('KontrollÃ¸r: '+(ctrlName.then? '': ctrlName), 4, y); y+=6;

    doc.text('TONO â€¢ GRAMO', 36, y, {align:'center'}); y+=4;

    const blob=doc.output('blob'); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='kontroll-'+(data.orgnr||'')+'.pdf'; a.click();
  }
  function printReceipt(){ generatePDF(getFormData()); }

  // === Import Excel ===
  async function importExcel(e){
    const file=e.target.files[0]; if(!file) return;
    try{
      const reader=new FileReader();
      reader.onload = async ev => {
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:'' });
        const head = (json[0]||[]).map(s=>String(s||'').trim().toLowerCase());
        const wanted = { org:['orgnummer','org nr','organisasjonsnr','organisasjonsnummer','orgnr'], navn:['navn','besÃ¸ksnavn','bedriftsnavn','foretaksnavn'], gate:['gateadresse','adresse','besÃ¸ksadresse','adressse','gatenavn'], postnr:['postnr','postnummer','post nr'], poststed:['poststed','sted'], kommentar:['kommentar','notat','note','merknad'] };
        const idx={}; Object.keys(wanted).forEach(k=>{ idx[k]= head.findIndex(h=> wanted[k].some(w=>h===w)); });
        const items=[];
        for(let r=1;r<json.length;r++){
          const row=json[r]||[];
          const get=(k)=>{ const i=idx[k]; if(i==null||i<0) return ''; return String(row[i]||'').trim(); };
          const org = get('org').replace(/\s+/g,'').replace(/[^0-9]/g,'');
          const itm = { Orgnummer: org, Navn:get('navn'), Gateadresse:get('gate'), Postnr:get('postnr'), Poststed:get('poststed'), Kommentar:get('kommentar'), color:0 };
          if(itm.Navn||itm.Gateadresse) items.push(itm);
        }
        const name = (file.name||'Liste').replace(/\.(xlsx|xls)$/i,'');
        await saveList(name, items);
      };
      reader.readAsArrayBuffer(file);
    }catch(err){ console.error(err); toast('Kunne ikke lese Excel'); }
  }

  // === Lister dashboard ===
  function openInForm(it){
    const fill=(id,val)=>{ const el=document.getElementById(id); if(el) el.value=(val||''); };
    fill('orgnr', it.Orgnummer||''); fill('navn', it.Navn||''); fill('besoksadresse', it.Gateadresse||'');
    fill('besoks_postnr', it.Postnr||''); fill('besoks_poststed', it.Poststed||''); show('kontroll');
    const n=(it.Orgnummer||'').replace(/\D/g,''); if(n.length===9){ (async()=>{ try{
      const r=await fetch('https://data.brreg.no/enhetsregisteret/api/enheter/'+n); if(!r.ok) return;
      const d=await r.json(); const a=d.forretningsadresse||d.beliggenhetsadresse||{};
      fill('firma', d.navn||''); fill('firma_postadresse', (a.adresse||a.adressebeskrivelse||a.gate||'')||'');
      fill('firma_postnr', a.postnummer||''); fill('firma_poststed', a.poststed||'');
    }catch(_){}})(); }
  }

  // zoom styrer bare innholdet i listene (font-size i viewport)
  let zoom=100;
  function applyZoom(){ document.querySelectorAll('.list-viewport').forEach(v=> v.style.setProperty('--fz', zoom+'%')); $$('#zoomLabel').textContent=zoom+'%'; }

  async function renderDashboard(){
    const lists=await fetchLists();
    const d=$$('#lists-dashboard'); d.innerHTML='';
    const q = ($$('#search').value||'').toLowerCase();

    lists.forEach(L=>{
      const box=document.createElement('div'); box.className='card';
      box.innerHTML = `
        <div class="list-header"><span>${sanitize(L.name)}</span>
          <small>${new Date(L.created_at).toLocaleDateString('nb-NO')}</small></div>
        <div class="list-viewport-wrap">
          <div class="list-viewport">
            <table>
              <thead><tr><th>Orgnummer</th><th>BesÃ¸ksnavn</th><th>Gateadresse</th><th>Post</th><th>Kommentar</th><th></th></tr></thead>
              <tbody id="tbody-${L.id}"></tbody>
            </table>
          </div>
        </div>`;
      d.appendChild(box);
      const tbody=$$('#tbody-'+L.id);

      (L.items||[]).forEach((it,i)=>{
        const hay=[it.Orgnummer,it.Navn,it.Gateadresse,it.Postnr,it.Poststed,it.Kommentar].join(' ').toLowerCase();
        if(q && !hay.includes(q)) return;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${sanitize(it.Orgnummer||'')}</td>
          <td><button class="link-cell" title="Ã…pne i skjema">${sanitize(it.Navn||'')}</button></td>
          <td>${sanitize(it.Gateadresse||'')}</td>
          <td>${sanitize((it.Postnr||'')+' '+(it.Poststed||''))}</td>
          <td contenteditable onblur="(async(el)=>{ const { data:list } = await supa.from('lists').select('*').eq('id','${L.id}').single(); list.items[${i}].Kommentar=el.innerText; await supa.from('lists').update({ items:list.items }).eq('id','${L.id}'); })(this)">${sanitize(it.Kommentar||'')}</td>
          <td><button class="btn-gray" title="KONTROLL">KONTROLL</button></td>`;
        tr.querySelector('.link-cell').addEventListener('click', ()=>openInForm(it));
        tr.querySelector('.btn-gray').addEventListener('click', ()=>openInForm(it));
        tbody.appendChild(tr);
      });
    });

    applyZoom();
  }

  // === Kontrollert (arkiv) ===
  async function renderArchive(){
    const rows=await fetchControls();
    const div=$$('#archive'); div.innerHTML='';
    if(!rows.length){ div.innerHTML='<div class="help">Ingen kontroller enda.</div>'; return; }

    const byMonth={}; rows.forEach(c=>{ const m=new Date(c.created_at).toLocaleDateString('nb-NO',{year:'numeric',month:'long'}); (byMonth[m]=byMonth[m]||[]).push(c); });
    Object.keys(byMonth).sort((a,b)=>a<b?1:-1).forEach(month=>{
      const header=document.createElement('div'); header.className='card'; header.innerHTML='<b>'+sanitize(month)+'</b>'; div.appendChild(header);
      byMonth[month].forEach(c=>{
        const data=c.data||{};
        const li=document.createElement('div'); li.className='card';
        const lines=(data.tariff||[]).map(t=>`${sanitize(t.venue)} â€¢ ${sanitize(t.music)} â€¢ ${sanitize(t.kvm)} kvm ${t.seter?('â€¢ '+sanitize(t.seter)+' seter â€¢ '):'â€¢ '}${sanitize(t.dager)} dager`).join('<br>');
        li.innerHTML = `<b>${sanitize(data.navn||'')}</b> â€“ ${new Date(c.created_at).toLocaleDateString('nb-NO')}
                        <div class="help"> ${lines||''} </div>
                        <div class="row"><button class="btn-gray" onclick="(${deleteControl.toString()})('${c.id}')">Slett</button></div>`;
        div.appendChild(li);
      });
    });
  }

  // === Export (poeng + dager) ===
  async function exportKontrollert(){
    const rows = await fetchControls();
    const byOrg = new Map();
    for(const c of rows){ const org=(c.data?.orgnr||'').trim(); if(!org) continue; if(!byOrg.has(org)) byOrg.set(org, []); byOrg.get(org).push(c); }

    const sheet=[['Orgnummer','Navn','Poeng (sum)','Kontrolldager (totalt)']];
    let totalPoints=0, totalDays=0;

    for(const [org,list] of byOrg.entries()){
      const latestName = list[0]?.data?.navn || list.at(-1)?.data?.navn || '';
      const sumPoints = list.reduce((s,c)=> s + pointsForControl(c.data), 0);
      const days = uniqueDaysForOrg(list);
      totalPoints += sumPoints; totalDays += days;
      sheet.push([org, latestName, sumPoints, days]);
    }
    sheet.push([]); sheet.push(['TOTALT','',''+totalPoints,''+totalDays]);

    const ws = XLSX.utils.aoa_to_sheet(sheet);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Kontrollert');
    XLSX.writeFile(wb, 'kontrollert_export.xlsx');
    toast('Eksport ferdig');
  }

  // === Events / init ===
  $$$('nav button').forEach(b=> b.addEventListener('click', ()=>show(b.dataset.page)));
  window.addEventListener('resize', applyNavPad, {passive:true});
  window.addEventListener('orientationchange', applyNavPad, {passive:true});
  applyNavPad();

  $$('#brregBtn').addEventListener('click', ()=>searchBrreg());
  $$('#orgnr').addEventListener('input', ()=>{ const n=$$('#orgnr').value.replace(/\D/g,''); if(n.length===9) searchBrregDebounced(); });

  $$('#addRowBtn').addEventListener('click', ()=>addRow());
  $$('#resetBtn').addEventListener('click', resetForm);
  $$('#saveDraftBtn').addEventListener('click', ()=>saveControl('draft'));
  $$('#sendBtn').addEventListener('click', ()=>{
  const data = getFormData();
  $$('#printBtn').addEventListener('click', printReceipt);
  $$('#excelFile').addEventListener('change', importExcel);
  $$('#logoutBtn').addEventListener('click', signOut);
  $$('#search').addEventListener('input', debounce(renderDashboard, 200));

  // Zoom-knapper (pÃ¥virker bare innhold i listene)
  $$('#zoomIn').addEventListener('click', ()=>{ zoom=Math.min(150, zoom+10); applyZoom(); });
  $$('#zoomOut').addEventListener('click', ()=>{ zoom=Math.max(60,  zoom-10); applyZoom(); });
  $$('#zoomReset').addEventListener('click', ()=>{ zoom=100; applyZoom(); });

  $$('#exportBtn').addEventListener('click', exportKontrollert);

  // Auth UI
  $$('#loginBtn').addEventListener('click', async (e)=>{
    e.preventDefault(); clearAuthError();
    const email=($$('#email').value||'').trim(); const password=($$('#password').value||'').trim();
    if(!email || !password){ setAuthStatus('Skriv inn e-post og passord.'); return; }
    setAuthStatus('Logger innâ€¦');
    try{ await loginEmailPass(email,password); setAuthStatus('Innlogget âœ”'); toast('Innlogget'); show('kontroll'); renderDashboard(); renderArchive(); updateTariffDefault(); }
    catch(err){ console.error(err); showAuthError(err); setAuthStatus('Innlogging feilet.'); alert('Innlogging feilet: '+(err?.message||err)); }
  });
  $$('#signupBtn').addEventListener('click', async ()=>{
    clearAuthError();
    const email=($$('#email').value||'').trim(); const password=($$('#password').value||'').trim();
    if(!email || !password){ setAuthStatus('Skriv inn e-post og passord for Ã¥ opprette.'); return; }
    setAuthStatus('Oppretterâ€¦');
    try{ await signupEmailPass(email,password); setAuthStatus('Bruker opprettet.'); toast('Bruker opprettet'); }
    catch(err){ console.error(err); showAuthError(err); setAuthStatus('Oppretting feilet.'); }
  });
  $$('#magicBtn').addEventListener('click', async ()=>{
    clearAuthError(); const email=($$('#email').value||'').trim(); if(!email){ setAuthStatus('Skriv inn e-post.'); return; }
    setAuthStatus('Sender magisk lenkeâ€¦'); try{ await magicLink(email); setAuthStatus('Magisk lenke sendt.'); toast('Sjekk e-post'); }
    catch(err){ console.error(err); showAuthError(err); setAuthStatus('Kunne ikke sende lenke.'); }
  });

  // Auth routing
  supa.auth.onAuthStateChange((_e, session)=>{ if(session?.user){ show('kontroll'); renderDashboard(); renderArchive(); updateTariffDefault(); } else { show('login'); } });
  (async function init(){
    const { data:{ session } } = await supa.auth.getSession();
    if(session?.user){ show('kontroll'); renderDashboard(); renderArchive(); updateTariffDefault(); }
    else { show('login'); updateTariffDefault(); }
  })();
})();
</script>
</body>
</html>
