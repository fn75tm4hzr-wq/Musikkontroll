<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Musikkontroll</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <style>
    :root{
      --bg:#f8fafc;--ink:#0f172a;--muted:#334155;--card:#fff;--br:#e2e8f0;--ok:#10b981;--warn:#f59e0b;--dark:#0f172a;--hint:#f1f5f9;
      --navpad: 180px; /* mer buffer slik at nederste linjer ikke havner bak nav */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font:16px -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin:0; background:var(--bg); color:var(--ink); padding-bottom:calc(var(--navpad) + env(safe-area-inset-bottom));}
    header{position:sticky;top:0;z-index:20;background:var(--dark);color:#fff;padding:12px env(safe-area-inset-left) 12px env(safe-area-inset-right);text-align:center;font-size:20px;font-weight:700}
    nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid var(--br);display:flex;z-index:30;padding-bottom:env(safe-area-inset-bottom)}
    nav button{flex:1;padding:16px;background:none;font-weight:600;color:var(--ink);border:none;font-size:16px;cursor:pointer}
    nav button.active{background:var(--dark);color:#fff}
    .page{display:none;padding:12px;max-width:760px;margin:auto}
    .page{padding-bottom:24px}
    .page.active{display:block}
    .page::after{content:"";display:block;height:calc(var(--navpad) + env(safe-area-inset-bottom));}

    .card{background:var(--card);padding:10px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.08);margin:8px 0}
    label{font-weight:600;color:var(--muted);margin:4px 0 6px;display:block;font-size:14px}
    input,select,textarea{width:100%;padding:10px;border:2px solid var(--br);border-radius:10px;font-size:16px}
    input[type="number"]{appearance:textfield}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
    .row>*{flex:1;min-width:120px}
    .row .icon-btn{width:36px;height:36px;font-size:18px;background:var(--hint);color:var(--ink);border:none;border-radius:8px;flex:0 0 auto;cursor:pointer}
    button{display:flex;align-items:center;justify-content:center;background:var(--dark);color:#fff;border:none;padding:12px;border-radius:10px;font-size:16px;font-weight:600;margin:4px 0;width:100%;cursor:pointer}
    .btn-green{background:var(--ok)}
    .btn-amber{background:var(--warn)}
    .btn-gray{background:#6b7280}
    .help{font-size:13px;color:#475569}
    .muted{color:#64748b}
    .dim{opacity:.6;pointer-events:none}
    .log{font-size:13px;color:var(--ok);background:#f0fdf4;padding:8px;border-radius:8px;margin-top:6px}
    .list-header{font-weight:600;display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px}
    .list-table{width:100%;border-collapse:collapse;margin-top:8px}
    .list-table th{position:sticky;top:0;background:var(--hint);padding:6px 8px;text-align:left;font-weight:700;font-size:14px}
    .list-table td{padding:6px 8px;vertical-align:top;border-bottom:1px solid var(--br);font-size:15px}
    .list-row{background:#fff}
    .list-row:hover{background:#f9fafb}
    .hidden{display:none}

    /* Lister: komprimert topp + zoom-container */
    #lister .card:first-of-type,
    #lister .card:nth-of-type(2){ padding:8px 10px; }
    #lister label{ margin-bottom:4px; }
    #lister input[type="file"]{ transform:scale(.95); transform-origin:left center; }
    #lister #search{ padding:10px; }
    #lists-viewport{ border:1px solid var(--br); border-radius:10px; overflow:auto; touch-action:pan-y; }
    #lists-dashboard{ transform-origin:0 0; }

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(70px + env(safe-area-inset-bottom));background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,.25);opacity:0;transition:opacity .25s}
    #toast.show{opacity:1}
  </style>
</head>
<body>
  <header aria-live="polite">ðŸŽµ Musikkontroll v1.8.5</header>

  <!-- LOGIN -->
  <main id="login" class="page active" role="main" aria-labelledby="login-title" style="max-width:420px">
    <h1 id="login-title">Logg inn</h1>
    <div class="card">
      <label for="email">E-post</label>
      <input id="email" type="email" autocomplete="username" />
      <label for="password">Passord</label>
      <input id="password" type="password" autocomplete="current-password" />
      <div class="row">
        <button type="button" id="loginBtn">Logg inn</button>
        <button type="button" class="btn-green" id="signupBtn">Opprett bruker</button>
      </div>
      <div class="row">
        <button type="button" class="btn-gray" id="magicBtn">Send magisk lenke</button>
      </div>
      <div id="auth-status" class="help muted" aria-live="polite"></div>
      <div id="auth-error" class="log" style="background:#fef2f2;color:#991b1b;display:none"></div>
    </div>
  </main>

  <!-- SKJEMA -->
  <div id="kontroll" class="page" aria-labelledby="kontroll-title">
    <h2 id="kontroll-title" class="visually-hidden">Kontrollskjema</h2>
    <div class="card" aria-describedby="brreg-hjelp">
      <label for="orgnr">Org.nr</label>
      <div class="row">
        <input id="orgnr" inputmode="numeric" pattern="\d{9}" maxlength="9" placeholder="9 siffer" aria-describedby="brreg-hjelp" />
        <button type="button" class="icon-btn" id="brregBtn" title="SÃ¸k i Enhetsregisteret">ðŸ”Ž</button>
      </div>
      <div id="brreg-hjelp" class="help">SÃ¸k henter navn og postadresse fra Brreg.</div>
      <div class="row">
        <button type="button" class="btn-gray" id="resetBtn">ðŸ—‘ Nullstill skjema</button>
        <button type="button" class="btn-gray" id="logoutBtn">Logg ut</button>
      </div>
      <div class="log" id="brreg-log" aria-live="polite"></div>
    </div>

    <div class="card"><label for="navn">BesÃ¸ksnavn</label><input id="navn" autocomplete="organization" /></div>
    <div class="card"><label for="besoksadresse">Adresse (besÃ¸k)</label><input id="besoksadresse" autocomplete="address-line1" /></div>
    <div class="card">
      <label>Post (besÃ¸k)</label>
      <div class="row"><input id="besoks_postnr" inputmode="numeric" maxlength="4" placeholder="Postnr"><input id="besoks_poststed" placeholder="Poststed"></div>
    </div>
    <div class="card"><label for="firma">Firmanavn</label><input id="firma" /></div>
    <div class="card">
      <label>Firmaadresse (post)</label>
      <div class="row"><input id="firma_postadresse" placeholder="Gateadresse"><input id="firma_postnr" inputmode="numeric" maxlength="4" placeholder="Postnr"><input id="firma_poststed" placeholder="Poststed"></div>
    </div>

    <div class="card">
      <strong>Linjer</strong>
      <div id="tariff-rows"></div>
      <button type="button" class="btn-green" id="addRowBtn">+ Ny linje</button>
      <label for="hoyttalere">HÃ¸yttalere</label><input id="hoyttalere">
      <label for="kommentar">Kommentar</label><textarea id="kommentar" rows="2"></textarea>
      <div class="row">
        <button type="button" id="saveDraftBtn">Lagre</button>
        <button type="button" class="btn-amber" id="printBtn">Print</button>
        <button type="button" class="btn-green" id="sendBtn">Send PDF</button>
      </div>
    </div>
  </div>

  <!-- LISTER -->
  <div id="lister" class="page" aria-labelledby="lister-title">
    <h2 id="lister-title" class="visually-hidden">Lister</h2>

    <div class="card">
      <label>Importer Excel</label>
      <input type="file" id="excelFile" accept=".xlsx" />
      <div class="help">Kolonner: Kommentar, Orgnummer, Navn, Gateadresse, Postnr, Poststed</div>
    </div>

    <div class="card">
      <label for="search">SÃ¸k</label>
      <input id="search" placeholder="Filtrer i aktive lister" />
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <label style="margin:0">Visning</label>
        <button type="button" class="btn-gray" id="zoomMinus" style="width:auto;min-width:56px">âˆ’</button>
        <span id="zoomPct" class="help" style="min-width:64px;text-align:center">100%</span>
        <button type="button" class="btn-gray" id="zoomPlus" style="width:auto;min-width:56px">+</button>
        <button type="button" class="btn-gray" id="zoomReset" style="width:auto;min-width:76px">Reset</button>
      </div>
    </div>

    <div id="lists-viewport" class="card" style="padding:0">
      <div id="lists-dashboard" style="padding:8px"></div>
    </div>
  </div>

  <!-- KONTROLLERT -->
  <div id="kontrollert" class="page" aria-labelledby="kontrollert-title">
    <h2 id="kontrollert-title" class="visually-hidden">Kontrollert</h2>

    <div class="card">
      <div class="row" style="align-items:center">
        <label for="expMonth" style="margin:0">Eksporter mÃ¥ned</label>
        <input type="month" id="expMonth" style="max-width:200px">
        <button type="button" id="exportBtn" class="btn-amber" style="width:auto">Eksporter Excel</button>
      </div>
      <div class="help">Poeng: Serveringssted 350, Kundelokale 200, Fremtredende 550. TONO og GRAMO fÃ¥r like mange poeng.</div>
    </div>

    <div id="archive"></div>
  </div>

  <nav aria-label="Hovednavigasjon">
    <button type="button" data-page="kontroll" class="active">Skjema</button>
    <button type="button" data-page="lister">Lister</button>
    <button type="button" data-page="kontrollert">Kontrollert</button>
  </nav>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
  (function(){
    if (!window.supabase || !window.supabase.createClient) {
      console.error('Supabase-biblioteket ble ikke lastet.');
      alert('Fikk ikke lastet Supabase-biblioteket. Skru av "shields"/adblock eller sjekk nettverk.');
      return;
    }
    const { createClient } = window.supabase;

    const SUPABASE_URL = 'https://lztitjaumvqgycpcvvwl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6dGl0amF1bXZxZ3ljcGN2dndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjQ2NTEsImV4cCI6MjA3Nzg0MDY1MX0.ZDK2ymr5vYG3HP5-j-CRv3UAe5G-VKGIUOObbhd6cyU';
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $$  = sel => document.querySelector(sel);
    const $$$ = sel => Array.from(document.querySelectorAll(sel));
    const toast=(msg)=>{ const t=$$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600); };
    const sanitize=(str='')=>String(str).replace(/[<>]/g,c=>({'<':'&lt;','>':'&gt;'}[c]));
    const debounce=(fn,ms=400)=>{ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a),ms); }; };
    function show(page){ $$$('.page').forEach(x=>x.classList.remove('active')); $$('#'+page).classList.add('active'); $$$('nav button').forEach(b=>b.classList.toggle('active', b.dataset.page===page)); if(page==='kontroll'){ try{document.scrollingElement.scrollTo({top:0,behavior:'instant'});}catch{} } }

    function setAuthBusy(busy){ ['loginBtn','signupBtn','magicBtn'].forEach(id=>{ const el=$$('#'+id); if(!el) return; el.disabled=!!busy; el.classList.toggle('dim', !!busy); }) }
    function showAuthError(err){ const box=$$('#auth-error'); if(!box) return; box.style.display='block'; box.textContent=err?.message||'Ukjent feil'; }
    function clearAuthError(){ const box=$$('#auth-error'); if(!box) return; box.style.display='none'; box.textContent=''; }
    async function currentUser(){ const { data:{ user } } = await supa.auth.getUser(); return user; }
    async function signOut(){ await supa.auth.signOut(); toast('Logget ut'); show('login'); }
    async function loginEmailPass(email,password){ const { error } = await supa.auth.signInWithPassword({ email, password }); if(error) throw error; }
    async function signupEmailPass(email,password){ const { error } = await supa.auth.signUp({ email, password }); if(error) throw error; }
    async function magicLink(email){ const { error } = await supa.auth.signInWithOtp({ email }); if(error) throw error; }

    // --- BRREG ---
    const brregLog=$$('#brreg-log');
    async function searchBrreg(){
      const n=$$('#orgnr').value.replace(/\D/g,'');
      if(n.length!==9){ if(brregLog) brregLog.textContent='Org.nr mÃ¥ ha 9 siffer'; return }
      if(brregLog) brregLog.textContent='SÃ¸kerâ€¦';
      try{
        const r=await fetch('https://data.brreg.no/enhetsregisteret/api/enheter/'+n);
        if(!r.ok) throw new Error('Ikke funnet');
        const d=await r.json();
        const a=d.forretningsadresse||d.beliggenhetsadresse||{};
        $$('#firma').value=d.navn||'';
        $$('#besoks_postnr').value=a.postnummer||'';
        $$('#besoks_poststed').value=a.poststed||'';
        $$('#firma_postadresse').value=(a.adresse||a.adressebeskrivelse||a.gate||'')||'';
        $$('#firma_postnr').value=a.postnummer||'';
        $$('#firma_poststed').value=a.poststed||'';
        if(brregLog) brregLog.textContent='Hentet postadresse';
      }catch(e){ if(brregLog) brregLog.textContent='Ikke funnet'; }
    }
    const searchBrregDebounced = debounce(searchBrreg, 350);

    // --- TARIFF-LINJER ---
    function chooseDays(music, venue){
      if(music==='Fremtredende musikk') return 104;
      return venue==='Serveringssted' ? 356 : 310;
    }
    function rowTemplate(preset){
      const kvm   = preset?.kvm   ?? '';
      const seter = preset?.seter ?? '';
      const music = preset?.music ?? 'Bakgrunnsmusikk';
      const venue = preset?.venue ?? 'Serveringssted';
      const dager = preset?.dager ?? chooseDays(music, venue);
      const showSeter = (venue === 'Serveringssted') ? '' : 'display:none';
      return `
      <div class="row tariff-row" data-music="${music}" data-venue="${venue}">
        <input type="number" placeholder="kvm" value="${sanitize(String(kvm))}">
        <input type="number" class="inp-seter" placeholder="sitteplasser" style="${showSeter}" value="${sanitize(String(seter))}">
        <input type="number" class="inp-dager" placeholder="dager/Ã¥r" value="${sanitize(String(dager))}">
        <select class="sel-music">
          <option ${music==='Bakgrunnsmusikk'?'selected':''}>Bakgrunnsmusikk</option>
          <option ${music==='Fremtredende musikk'?'selected':''}>Fremtredende musikk</option>
        </select>
        <select class="sel-venue">
          <option ${venue==='Serveringssted'?'selected':''}>Serveringssted</option>
          <option ${venue==='Kundelokale'?'selected':''}>Kundelokale</option>
        </select>
        <button type="button" class="icon-btn" title="Fjern" onclick="this.closest('.tariff-row').remove()">âˆ’</button>
      </div>`;
    }
    function wireRow(row){
      const selVenue=row.querySelector('.sel-venue');
      const selMusic=row.querySelector('.sel-music');
      const inpSeter=row.querySelector('.inp-seter');
      const inpDager=row.querySelector('.inp-dager');
      function refresh(){
        const venue=selVenue.value, music=selMusic.value;
        if(venue==='Serveringssted'){ inpSeter.style.display=''; } else { inpSeter.style.display='none'; inpSeter.value=''; }
        if(!inpDager.value || Number(inpDager.value)<=0){ inpDager.value=chooseDays(music, venue); }
      }
      selVenue.addEventListener('change', refresh);
      selMusic.addEventListener('change', refresh);
      refresh();
    }
    function updateTariffDefault(){ $$('#tariff-rows').innerHTML=''; addRow(); }
    function addRow(preset){ const cont=$$('#tariff-rows'); cont.insertAdjacentHTML('beforeend', rowTemplate(preset)); wireRow(cont.lastElementChild); }

    function getFormData(){
      const rows=[];
      $$('#tariff-rows').querySelectorAll('.tariff-row').forEach(r=>{
        const i=r.querySelectorAll('input,select');
        const kvm=i[0].value;
        const seter=i[1].style.display==='none' ? '' : i[1].value;
        const dager=i[2].value;
        const music=i[3].value;
        const venue=i[4].value;
        rows.push({ kvm, seter, dager, music, venue });
      });
      return {
        orgnr: $$('#orgnr').value,
        navn: $$('#navn').value,
        adresse: $$('#besoksadresse').value,
        postnr: $$('#besoks_postnr').value,
        poststed: $$('#besoks_poststed').value,
        firma: $$('#firma').value,
        firma_postadresse: $$('#firma_postadresse')?.value || '',
        firma_postnr: $$('#firma_postnr')?.value || '',
        firma_poststed: $$('#firma_poststed')?.value || '',
        tariff: rows,
        hoyttalere: $$('#hoyttalere').value,
        kommentar: $$('#kommentar').value,
        dato: new Date().toISOString()
      };
    }
    function resetForm(){
      if(!confirm('Nullstille hele skjemaet?')) return;
      ['orgnr','navn','besoksadresse','besoks_postnr','besoks_poststed','firma','firma_postadresse','firma_postnr','firma_poststed','hoyttalere','kommentar'].forEach(id=> $$('#'+id).value='');
      updateTariffDefault();
      if(brregLog) brregLog.textContent='';
      toast('Skjema nullstilt');
    }

    // --- SUPABASE DATA ---
    async function saveControl(status){
      const user = await currentUser(); if(!user){ toast('Innlogging kreves'); return }
      const payload=getFormData();
      const { error } = await supa.from('controls').insert({ user_id:user.id, orgnr: payload.orgnr||null, data: payload, status });
      if(error){ console.error(error); toast('Kunne ikke lagre'); return }
      toast(status==='sent'?'Sendt':'Lagret');
      if(status==='sent'){ await generatePDF(payload); await renderArchive(); }
    }
    async function fetchControls(){ const { data, error } = await supa.from('controls').select('*').order('created_at',{ ascending:false }); if(error){ console.error(error); return [] } return data; }
    async function saveList(name, items){ const user = await currentUser(); if(!user){ toast('Innlogging kreves'); return } const { error } = await supa.from('lists').insert({ user_id:user.id, name, items }); if(error){ console.error(error); toast('Kunne ikke lagre liste'); return } toast('Liste importert'); await renderDashboard(); }
    async function fetchLists(){ const { data, error } = await supa.from('lists').select('*').order('created_at',{ ascending:false }); if(error){ console.error(error); return [] } return data; }

    // --- PDF ---
    async function imgDataUrl(path){
      const r = await fetch(path); const b = await r.blob();
      return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(b); });
    }
    function firstNameFromSession(session){
      const email = session?.user?.email || '';
      const guess = email.split('@')[0].split(/[.\-_]/)[0];
      return (session?.user?.user_metadata?.full_name?.split(' ')[0]) || (guess?guess.charAt(0).toUpperCase()+guess.slice(1):'');
    }
    async function generatePDF(data){
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF){ alert('PDF-bibliotek mangler'); return }
      let tono=null, gramo=null;
      try{ tono=await imgDataUrl('tono_logo.png'); gramo=await imgDataUrl('gramo_logo.png'); }catch{}
      const { data:{ session } } = await supa.auth.getSession();
      const kontrollor = firstNameFromSession(session);

      const doc=new jsPDF({ unit:'mm', format:[72,200] });
      let y=8;
      if(tono||gramo){
        const w=26, gap=4, x1=4, x2=x1+w+gap;
        if(tono)  doc.addImage(tono,'PNG',x1,y,w,10,undefined,'FAST');
        if(gramo) doc.addImage(gramo,'PNG',x2,y,w,10,undefined,'FAST');
        y+=12;
      }
      doc.setFontSize(11); doc.text('Kontrollskjema for bruk av musikk',4,y); y+=6;
      doc.setFontSize(9);
      doc.text('BesÃ¸ksnavn: '+(data.navn||''),4,y); y+=5;
      doc.text('BesÃ¸ksadresse: '+(data.adresse||''),4,y); y+=5;
      doc.text('Post: '+(data.postnr||'')+' '+(data.poststed||''),4,y); y+=5;
      const dt=new Date();
      doc.text('Kontrollert: '+dt.toLocaleDateString('nb-NO')+' kl '+dt.toLocaleTimeString('nb-NO',{hour:'2-digit',minute:'2-digit'}),4,y); y+=5;
      doc.text('KontrollÃ¸r: '+(kontrollor||''),4,y); y+=6;

      doc.setFontSize(10); doc.text('Linjer:',4,y); y+=5; doc.setFontSize(9);
      (data.tariff||[]).forEach((t,i)=>{
        const parts=[
          `${i+1}. ${(t.music==='Fremtredende musikk')?'Fremtredende musikk':'Bakgrunnsmusikk'}`,
          'â€¢ '+(t.venue||'Serveringssted'),
          (t.kvm? `â€¢ ${t.kvm} kvm`:''),
          (t.seter? `â€¢ ${t.seter} seter`:''),
          (t.dager? `â€¢ ${t.dager} dager/Ã¥r`:'')
        ].filter(Boolean).join(' ');
        doc.text(parts,6,y); y+=5;
      });
      y+=2;
      doc.text('HÃ¸yttalere:',4,y); y+=4;
      const splitH=doc.splitTextToSize(data.hoyttalere||'',64); if(splitH.length){ doc.text(splitH,4,y); y+=splitH.length*4+2; }
      doc.text('Kommentar:',4,y); y+=4;
      const split=doc.splitTextToSize(data.kommentar||'',64); if(split.length){ doc.text(split,4,y); y+=split.length*4+2; }

      y+=4; doc.setFontSize(8); doc.text('TONO â€¢ GRAMO',4,y); y+=4; doc.text('TONO â€“ Kongens gate 12, 0153 Oslo â€“ www.tono.no',4,y);

      const blob=doc.output('blob'); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='kontroll-'+(data.orgnr||'')+'.pdf'; a.click();
    }
    function printReceipt(){ generatePDF(getFormData()); }

    // --- IMPORT LISTE & DASHBOARD ---
    async function importExcel(e){
      const file=e.target.files[0]; if(!file) return;
      try{
        const reader=new FileReader();
        reader.onload= async ev=>{
          const data=new Uint8Array(ev.target.result);
          const wb=XLSX.read(data,{type:'array'});
          const sheet=wb.SheetNames[0];
          const ws=wb.Sheets[sheet];
          const json=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:''});
          const head=(json[0]||[]).map(s=>String(s||'').trim().toLowerCase());
          const wanted={ org:['orgnummer','org nr','organisasjonsnr','organisasjonsnummer','orgnr'], navn:['navn','besÃ¸ksnavn','bedriftsnavn','foretaksnavn'], gate:['gateadresse','adresse','besÃ¸ksadresse','adressse','gatenavn'], postnr:['postnr','postnummer','post nr'], poststed:['poststed','sted'], kommentar:['kommentar','notat','note','merknad'] };
          const idx={}; Object.keys(wanted).forEach(k=>{ idx[k]=head.findIndex(h=>wanted[k].some(w=>h===w)); });
          const items=[];
          for(let r=1;r<json.length;r++){
            const row=json[r]||[];
            const get=(k)=>{ const i=idx[k]; if(i==null||i<0) return ''; return String(row[i]||'').trim(); };
            const org=get('org').replace(/\s+/g,'').replace(/[^0-9]/g,'');
            const itm={ Orgnummer:org, Navn:get('navn'), Gateadresse:get('gate'), Postnr:get('postnr'), Poststed:get('poststed'), Kommentar:get('kommentar'), color:0 };
            if(itm.Navn||itm.Gateadresse) items.push(itm);
          }
          const name=(file.name||'Liste').replace(/\.(xlsx|xls)$/i,'');
          await saveList(name, items);
        };
        reader.readAsArrayBuffer(file);
      }catch(err){ console.error(err); toast('Kunne ikke lese Excel'); }
    }

    async function renderDashboard(){
      const lists=await fetchLists();
      const d=$$('#lists-dashboard'); d.innerHTML='';
      const q = ($$('#search').value||'').toLowerCase();
      lists.forEach(L=>{
        const box=document.createElement('div'); box.className='card';
        box.innerHTML=`
          <div class="list-header"><span>${sanitize(L.name)}</span><small>${new Date(L.created_at).toLocaleDateString('nb-NO')}</small></div>
          <div class="help">${L.items.length} steder</div>
          <div style="max-height:360px;overflow:auto;border:1px solid var(--br);border-radius:10px">
            <table class="list-table">
              <thead><tr><th>Orgnummer</th><th>BesÃ¸ksnavn</th><th>Gateadresse</th><th>Post</th><th>Kommentar</th><th></th></tr></thead>
              <tbody id="tbody-${L.id}"></tbody>
            </table>
          </div>`;
        d.appendChild(box);
        const tbody=$$('#tbody-'+L.id);
        L.items.forEach((it,i)=>{
          const hay=[it.Orgnummer,it.Navn,it.Gateadresse,it.Postnr,it.Poststed,it.Kommentar].join(' ').toLowerCase();
          if(q && !hay.includes(q)) return;
          const tr=document.createElement('tr'); tr.className='list-row';
          tr.innerHTML=`
            <td>${sanitize(it.Orgnummer||'')}</td>
            <td><strong>${sanitize(it.Navn||'')}</strong></td>
            <td>${sanitize(it.Gateadresse||'')}</td>
            <td>${sanitize((it.Postnr||'')+' '+(it.Poststed||''))}</td>
            <td contenteditable
                onblur="(async()=>{ const el=this; try{ const { data:list } = await supa.from('lists').select('*').eq('id','${L.id}').single(); list.items[${i}].Kommentar=el.innerText; await supa.from('lists').update({ items:list.items }).eq('id','${L.id}'); }catch(e){ console.error(e) } })()">
              ${sanitize(it.Kommentar||'')}
            </td>
            <td>
              <button class="btn-gray" style="width:auto" title="Start kontroll"
                onclick='(function(){
                  document.getElementById("orgnr").value=${JSON.stringify(it.Orgnummer||'')};
                  document.getElementById("navn").value=${JSON.stringify(it.Navn||'')};
                  document.getElementById("besoksadresse").value=${JSON.stringify(it.Gateadresse||'')};
                  document.getElementById("besoks_postnr").value=${JSON.stringify(it.Postnr||'')};
                  document.getElementById("besoks_poststed").value=${JSON.stringify(it.Poststed||'')};
                  document.querySelector("#tariff-rows").innerHTML="";
                  addRow({ music:"Bakgrunnsmusikk", venue:"Serveringssted" });
                  show("kontroll");
                })()'>KONTROLL</button>
            </td>`;
          tbody.appendChild(tr);
        });
      });
    }

    // --- KONTROLLERT: eksport/slett ---
    function pointsForLine(line){
      if(line.music==='Fremtredende musikk') return 550;
      return line.venue==='Serveringssted' ? 350 : 200;
    }
    function monthKey(d){ return new Date(d).toISOString().slice(0,7); }
    $$('#exportBtn').addEventListener('click', async ()=>{
      const pick = $$('#expMonth').value || monthKey(new Date());
      const rows = await fetchControls();
      const sel  = rows.filter(r => monthKey(r.created_at) === pick);

      let antKontroller = sel.length;
      let antDager = 0;
      let poeng = 0;

      const sheet = [['Dato','Navn','Orgnr','Adresse','Post','Linjer','Kontrolldager','Poeng (TONO)','Poeng (GRAMO)']];
      sel.forEach(c=>{
        const d=c.data||{};
        const linjer=(d.tariff||[]).map(t=>{
          antDager += Number(t.dager||0);
          poeng    += pointsForLine(t);
          return [t.music||'', t.venue||'', t.kvm?`${t.kvm} kvm`:'', t.seter?`${t.seter} seter`:'', t.dager?`${t.dager} dager`:''].filter(Boolean).join(' â€¢ ');
        }).join('\n');
        sheet.push([
          new Date(c.created_at).toLocaleDateString('nb-NO'),
          d.navn||'', d.orgnr||'',
          d.adresse||'',
          ((d.postnr||'')+' '+(d.poststed||'')).trim(),
          linjer,
          (d.tariff||[]).reduce((s,t)=>s+Number(t.dager||0),0),
          poeng, poeng
        ]);
      });
      sheet.push([]); sheet.push(['SUM','','','','','',antDager,poeng,poeng]); sheet.push(['Antall kontroller', antKontroller]);

      const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(sheet);
      XLSX.utils.book_append_sheet(wb, ws, 'Eksport '+pick);
      XLSX.writeFile(wb, `kontrollert_${pick}.xlsx`);
    });

    async function renderArchive(){
      const rows=await fetchControls();
      const div=$$('#archive'); div.innerHTML='';
      const byMonth={};
      rows.forEach(c=>{ const m=new Date(c.created_at).toLocaleDateString('nb-NO',{year:'numeric',month:'long'}); (byMonth[m]=byMonth[m]||[]).push(c); });
      Object.keys(byMonth).sort().reverse().forEach(month=>{
        const el=document.createElement('div'); el.className='card'; el.innerHTML='<b>'+sanitize(month)+'</b>'; div.appendChild(el);
        byMonth[month].forEach(c=>{
          const data=c.data||{};
          const inner=document.createElement('div'); inner.className='card';
          inner.innerHTML=`
            <b>${sanitize(data.navn||'')}</b> â€“ ${new Date(c.created_at).toLocaleDateString('nb-NO')}
            <div class="help" style="margin:6px 0">${(data.tariff||[]).map(t=>`${sanitize(t.music)} â€¢ ${sanitize(t.venue)} â€¢ ${sanitize(t.kvm||'')} kvm ${t.seter?('â€¢ '+sanitize(t.seter)+' seter â€¢ '):'â€¢ '}${sanitize(t.dager||'')} dager`).join('<br>')}</div>
            <div class="row" style="gap:8px">
              <button type="button" class="btn-gray" style="width:auto" onclick="(async()=>{ if(!confirm('Slette denne kontrollen?')) return; await supa.from('controls').delete().eq('id','${c.id}'); await (${renderArchive.toString()})(); })()">Slett</button>
            </div>`;
          div.appendChild(inner);
        });
      });
    }

    // --- LISTER ZOOM ---
    let listScale=1;
    function applyListScale(){ $$('#lists-dashboard').style.transform=`scale(${listScale})`; $$('#zoomPct').textContent=Math.round(listScale*100)+'%'; }
    $$('#zoomPlus').addEventListener('click', ()=>{ listScale=Math.min(2, listScale+0.1); applyListScale(); });
    $$('#zoomMinus').addEventListener('click',()=>{ listScale=Math.max(0.6, listScale-0.1); applyListScale(); });
    $$('#zoomReset').addEventListener('click',()=>{ listScale=1; applyListScale(); });
    applyListScale();

    // --- EVENTS ---
    $$$('nav button').forEach(b=> b.addEventListener('click', ()=>{ show(b.dataset.page); }));
    $$('#brregBtn').addEventListener('click', ()=>searchBrreg());
    $$('#orgnr').addEventListener('input', ()=>{ const n=$$('#orgnr').value.replace(/\D/g,''); if(n.length===9) searchBrregDebounced(); });
    $$('#addRowBtn').addEventListener('click', ()=>addRow());
    $$('#resetBtn').addEventListener('click', resetForm);
    $$('#saveDraftBtn').addEventListener('click', ()=>saveControl('draft'));
    $$('#sendBtn').addEventListener('click', ()=>saveControl('sent'));
    $$('#printBtn').addEventListener('click', printReceipt);
    $$('#excelFile').addEventListener('change', importExcel);
    $$('#logoutBtn').addEventListener('click', signOut);
    $$('#search').addEventListener('input', debounce(renderDashboard, 200));

    $$('#loginBtn').addEventListener('click', async (e)=>{
      e.preventDefault(); clearAuthError();
      const email=($$('#email').value||'').trim();
      const password=($$('#password').value||'').trim();
      if(!email||!password){ $$('#auth-status').textContent='Skriv inn e-post og passord.'; return }
      setAuthBusy(true); $$('#auth-status').textContent='Logger innâ€¦';
      try{
        await loginEmailPass(email,password);
        $$('#auth-status').textContent='Innlogget âœ”'; toast('Innlogget');
        show('kontroll'); updateTariffDefault(); renderDashboard(); renderArchive();
      }catch(err){
        console.error('Login error:',err); showAuthError(err);
        $$('#auth-status').textContent='Innlogging feilet.';
        alert('Innlogging feilet: '+(err?.message||String(err)));
      }finally{ setAuthBusy(false); }
    });
    ['#email','#password'].forEach(sel=>{
      $$(sel).addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') $$('#loginBtn').click(); });
    });
    $$('#signupBtn').addEventListener('click', async ()=>{
      clearAuthError();
      const email=($$('#email').value||'').trim();
      const password=($$('#password').value||'').trim();
      if(!email||!password){ $$('#auth-status').textContent='Skriv inn e-post og passord for Ã¥ opprette.'; return; }
      setAuthBusy(true); $$('#auth-status').textContent='Oppretter brukerâ€¦';
      try{ await signupEmailPass(email,password); toast('Bruker opprettet'); $$('#auth-status').textContent='Bruker opprettet. Sjekk ev. bekreftelses-epost.'; }
      catch(err){ console.error('Signup error:',err); showAuthError(err); alert('Oppretting feilet: '+(err?.message||String(err))); }
      finally{ setAuthBusy(false); }
    });
    $$('#magicBtn').addEventListener('click', async ()=>{
      clearAuthError();
      const email=($$('#email').value||'').trim();
      if(!email){ $$('#auth-status').textContent='Skriv inn e-post for Ã¥ fÃ¥ lenke.'; return; }
      setAuthBusy(true); $$('#auth-status').textContent='Sender magisk lenkeâ€¦';
      try{ await magicLink(email); toast('Sjekk e-post for magisk lenke'); $$('#auth-status').textContent='Magisk lenke sendt.'; }
      catch(err){ console.error('Magic link error:',err); showAuthError(err); alert('Kunne ikke sende lenke: '+(err?.message||String(err))); }
      finally{ setAuthBusy(false); }
    });

    supa.auth.onAuthStateChange((_e, session)=>{ if(session?.user){ show('kontroll'); updateTariffDefault(); renderDashboard(); renderArchive(); } else { show('login'); } });
    (async function init(){
      const { data:{ session } } = await supa.auth.getSession();
      if(session?.user){ show('kontroll'); updateTariffDefault(); renderDashboard(); renderArchive(); }
      else { show('login'); updateTariffDefault(); }
    })();

  })();
  </script>
</body>
</html>
